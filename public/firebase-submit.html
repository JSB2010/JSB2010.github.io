<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Submit</title>
</head>
<body>
  <div id="status">Ready to receive form data</div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCZAmGriqlYJL_RLvRx7iKGQz7pbY2nrB0",
      authDomain: "jacob-barkin-website.firebaseapp.com",
      projectId: "jacob-barkin-website",
      storageBucket: "jacob-barkin-website.firebasestorage.app",
      messagingSenderId: "1093183769646",
      appId: "1:1093183769646:web:0fbbcd20023cb9ec8823bf",
      measurementId: "G-KTBS67S2PC"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Log status
    function logStatus(message) {
      console.log(message);
      document.getElementById('status').textContent = message;
      
      // Send log message to parent
      try {
        window.parent.postMessage({
          type: 'LOG',
          message: message
        }, '*');
      } catch (error) {
        console.error('Error sending log to parent:', error);
      }
    }
    
    // Function to submit form data to Firestore
    async function submitToFirestore(formData) {
      try {
        logStatus('Received form data, preparing to submit...');
        
        // Add timestamp
        formData.timestamp = serverTimestamp();
        
        // Submit to Firestore
        logStatus('Submitting to Firestore...');
        const contactSubmissionsRef = collection(db, 'contactSubmissions');
        const docRef = await addDoc(contactSubmissionsRef, formData);
        
        logStatus(`Successfully submitted to Firestore with ID: ${docRef.id}`);
        
        // Send success message to parent
        window.parent.postMessage({
          type: 'SUCCESS',
          documentId: docRef.id
        }, '*');
        
        return true;
      } catch (error) {
        logStatus(`Error submitting to Firestore: ${error.message}`);
        console.error('Error submitting to Firestore:', error);
        
        // Send error message to parent
        window.parent.postMessage({
          type: 'ERROR',
          message: error.message
        }, '*');
        
        return false;
      }
    }
    
    // Listen for messages from the parent window
    window.addEventListener('message', async (event) => {
      // For security, you might want to check event.origin
      // if (event.origin !== "https://your-domain.com") return;
      
      if (event.data && event.data.type === 'SUBMIT') {
        logStatus('Received submission request from parent');
        await submitToFirestore(event.data.formData);
      }
    });
    
    // Notify parent that we're ready
    window.parent.postMessage({
      type: 'READY'
    }, '*');
    
    logStatus('Firebase initialized and ready to receive submissions');
  </script>
</body>
</html>
