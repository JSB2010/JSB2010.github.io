<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Form Submission</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
      color: #333;
      background-color: #f9f9f9;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 24px;
    }
    h1 {
      margin-top: 0;
      color: #2563eb;
    }
    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 6px;
    }
    .success {
      background-color: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .error {
      background-color: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .logs {
      margin-top: 20px;
      padding: 16px;
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .logs div {
      margin-bottom: 4px;
    }
    .button {
      display: inline-block;
      background-color: #2563eb;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 500;
      margin-top: 16px;
    }
    .button:hover {
      background-color: #1d4ed8;
    }
    .hidden {
      display: none;
    }
    .data-item {
      margin-bottom: 8px;
    }
    .data-label {
      font-weight: bold;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Contact Form Submission</h1>
    <p>This page will automatically submit your contact form data to Firestore.</p>
    
    <div id="submissionData" class="hidden">
      <h2>Submission Data:</h2>
      <div id="dataDisplay"></div>
    </div>
    
    <div id="result" class="result hidden"></div>
    
    <a href="javascript:history.back()" class="button" id="backButton">Return to Website</a>
  </div>
  
  <div class="logs" id="logs"></div>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js';
    
    // Log function
    function log(message) {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }
    
    // Show result
    function showResult(message, isSuccess) {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = message;
      resultDiv.className = isSuccess ? 'result success' : 'result error';
      resultDiv.classList.remove('hidden');
    }
    
    // Parse query parameters
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      
      for (const [key, value] of urlParams.entries()) {
        params[key] = decodeURIComponent(value);
      }
      
      return params;
    }
    
    // Display submission data
    function displaySubmissionData(data) {
      const dataDisplay = document.getElementById('dataDisplay');
      const submissionData = document.getElementById('submissionData');
      
      if (data && Object.keys(data).length > 0) {
        submissionData.classList.remove('hidden');
        
        for (const [key, value] of Object.entries(data)) {
          if (key !== 'source' && key !== 'userAgent') {
            const item = document.createElement('div');
            item.className = 'data-item';
            
            const label = document.createElement('span');
            label.className = 'data-label';
            label.textContent = key.charAt(0).toUpperCase() + key.slice(1) + ':';
            
            const valueSpan = document.createElement('span');
            valueSpan.textContent = value;
            
            item.appendChild(label);
            item.appendChild(valueSpan);
            dataDisplay.appendChild(item);
          }
        }
      }
    }
    
    // Initialize Firebase
    log('Initializing Firebase...');
    const firebaseConfig = {
      apiKey: "AIzaSyCZAmGriqlYJL_RLvRx7iKGQz7pbY2nrB0",
      authDomain: "jacob-barkin-website.firebaseapp.com",
      projectId: "jacob-barkin-website",
      storageBucket: "jacob-barkin-website.firebasestorage.app",
      messagingSenderId: "1093183769646",
      appId: "1:1093183769646:web:0fbbcd20023cb9ec8823bf",
      measurementId: "G-KTBS67S2PC"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    log('Firebase initialized successfully');
    
    // Main function to submit data
    async function submitData() {
      try {
        // Get data from query parameters
        const params = getQueryParams();
        log('Received data from query parameters');
        
        // Check if we have the required fields
        if (!params.name || !params.email || !params.message) {
          log('ERROR: Missing required fields');
          showResult('Missing required fields. Please go back and fill out all required fields.', false);
          return;
        }
        
        // Display the submission data
        displaySubmissionData(params);
        
        // Prepare submission data
        const submissionData = {
          name: params.name,
          email: params.email,
          subject: params.subject || 'Contact Form Submission',
          message: params.message,
          timestamp: serverTimestamp(),
          userAgent: navigator.userAgent,
          source: 'website_contact_form_redirect'
        };
        
        log(`Submission data prepared: ${JSON.stringify({
          name: params.name,
          email: params.email,
          subject: params.subject,
          messageLength: params.message.length
        })}`);
        
        log('Submitting to Firestore...');
        log(`Current origin: ${window.location.origin}`);
        
        // Submit to Firestore
        const contactSubmissionsRef = collection(db, 'contactSubmissions');
        const docRef = await addDoc(contactSubmissionsRef, submissionData);
        
        log(`Successfully submitted to Firestore with ID: ${docRef.id}`);
        showResult('Your message has been sent successfully! You can now return to the website.', true);
        
        // Update the back button text
        document.getElementById('backButton').textContent = 'Return to Website';
      } catch (error) {
        log(`ERROR: ${error.message}`);
        
        if (error.code) {
          log(`Error code: ${error.code}`);
        }
        
        showResult(`Error: ${error.message}. Please try again or contact directly via email.`, false);
      }
    }
    
    // Run the submission when the page loads
    window.addEventListener('DOMContentLoaded', submitData);
    
    // Initial log
    log('Page loaded and ready');
  </script>
</body>
</html>
